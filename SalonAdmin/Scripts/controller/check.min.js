app.controller("check",["$scope","$stateParams","purchasedServiceAPIService","employeeAPIService","appointmentAPIService","consumedServiceAPIService","dialogService","serviceAPIService","userAPIService",function(n,t,i,r,u,f,e,o,s){function v(t){u.getAvaiAppointments(h).then(function(i){n.appointments=i.data;for(var r=0;r<n.appointments.length;r++)if(n.appointments[r].appointmentId==t){n.selectedAppointment=n.appointments[r];break}})}function p(t){o.getAvaiServices(h).then(function(i){n.purchasedServices=i.data;for(var r=0;r<n.purchasedServices.length;r++)if(n.purchasedServices[r].serviceId==t){n.purchasedService=n.purchasedServices[r];break}})}function y(t){r.getBeauticians().then(function(i){n.beauticians=i.data;for(var r=0;r<n.beauticians.length;r++)if(n.beauticians[r].employeeId==t){n.selectedBeautician=n.beauticians[r];break}})}n.purchasedService=null;n.beauticians=null;n.selectedBeautician=null;n.purchasedServices=null;n.appointments=null;n.selectedAppointment=null;n.aoCharge={employeeId:null,time:1,appointmentId:null,changeTimeReason:null};n.isPreview=!1;n.title;n.action;var h,l,c,a;t.userId!=null?(n.action="aocharge",h=t.userId,c=t.purchasedServiceId,n.title="创建消费单",n.routeName="purchasedservice/"+c+"/"+h,i.getPurchasedService(c).then(function(t){n.purchasedService=t.data}),y(),v()):t.consumeCode!=null?(n.action="aoscan",l=t.consumeCode,n.title="创建消费单",n.routeName="home",s.getUserId(l).then(function(n){h=n.data;p();v();y()},function(n){e.showMention(1,n.data[0],"home")})):t.consumedServiceId!=null&&(n.action="update",a=t.consumedServiceId,n.routeName="consumedservices",n.title="修改消费单",f.getConsumedService(a).then(function(t){n.aoCharge.time=t.data.time;n.aoCharge.changeTimeReason=t.data.changeTimeReason;h=t.data.userId;y(t.data.employeeId);v(t.data.appointmentId);p(t.data.serviceId)}));n.selectBeautician=function(t){n.selectedBeautician=t};n.selectAppointment=function(t){n.selectedAppointment=n.selectedAppointment==t?null:t};n.selectPurchasedService=function(t){n.purchasedService=t};n.submit=function(){n.aoCharge.employeeId=n.selectedBeautician.employeeId;n.selectedAppointment!=null&&(n.aoCharge.appointmentId=n.selectedAppointment.appointmentId);n.action=="aocharge"?(n.aoCharge.purchasedServiceId=c,f.aoCharge(n.aoCharge).then(function(){e.showMention(1,"店方完成单方面扣费，请务必敦促用户当面完成确认，否则本次扣费不成功！","purchasedservice",{purchasedServiceId:c,userId:h})})):n.action=="aoscan"?(n.aoCharge.serviceId=n.purchasedService.serviceId,n.aoCharge.consumeCode=l,f.aoScan(n.aoCharge).then(function(){e.showMention(1,"店方完成单方面扣费，请务必敦促用户当面完成确认，否则本次扣费不成功！","home")})):n.action=="update"&&(n.aoCharge.serviceId=n.purchasedService.serviceId,n.aoCharge.consumedServiceId=a,f.changeConsumedService(n.aoCharge).then(function(){e.showMention(1,"修改消费单成功，请务必敦促用户当面完成确认，否则本次扣费不成功！")}))}}]);