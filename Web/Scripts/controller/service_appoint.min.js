app.controller("service_appoint",["$scope","locationEx","serviceAPIService","$stateParams","appointmentAPIService","routeService","dialogService","$rootScope",function(n,t,i,r,u,f,e,o){function s(){var i,r,t;if(n.selectedBeautician!=null&&n.selectedDate!=null){for(n.isSalonClose=!1,n.isBeauticianDayoff=!1,t=0;t<n.times.length;t++)n.times[t].isAvailable=!0;if(n.selectedDate.isSalonClose){n.isSalonClose=!0;return}for(i=null,r=0;r<n.selectedBeautician.avaiDates.length;r++)if(i=n.selectedBeautician.avaiDates[r],i.date==n.selectedDate.date){if(i.isDayoff){n.isBeauticianDayoff=!0;return}for(t=0;t<i.avaiTimes.length;t++)n.times[t].isAvailable=i.avaiTimes[t].isAvailable,n.selectedTime!=n.times[t]||n.times[t].isAvailable||(n.selectedTime=null);break}}}var h=t.queryString("identitycode");n.serviceId=r.serviceId;n.selectedBeautician=null;n.selectedDate=null;n.selectedTime=null;n.isSalonClose=!1;n.isBeauticianDayoff=!1;n.avaiAppointments=null;i.getService(n.serviceId,h).then(function(t){n.service=t.data;o.pageTitle=n.service.serviceName});u.getAvaiAppointments(n.serviceId).then(function(t){var r,i;if(t.data!=null){for(n.avaiAppointments=t.data,n.selectedBeautician=n.avaiAppointments.beauticians[0],n.selectedDate=n.avaiAppointments.beauticians[0].avaiDates[0],n.times=[],r=n.avaiAppointments.beauticians[0].avaiDates[0].avaiTimes,i=0;i<r.length;i++)n.times.push({time:new timeSpan(r[i].time),isAvailable:!0});s()}});n.selectBeautician=function(t){n.selectedBeautician!=t&&(n.selectedBeautician=t,s())};n.selectDate=function(t){n.selectedDate!=t&&(n.selectedDate=t,s())};n.selectTime=function(t){t.isAvailable&&(n.selectedTime=t)};n.appoint=function(){if(n.selectedBeautician==null){e.showMention(1,"请选择技师");return}if(n.selectedDate==null){e.showMention(1,"请选择日期");return}if(n.selectedTime==null){e.showMention(1,"请选择时间");return}var t={serviceId:n.serviceId,employeeId:n.selectedBeautician.employeeId,appointmentDate:n.selectedDate.date.toDateString()+"T"+n.selectedTime.time.toString()};u.createAppointment(t).then(function(){var t={serviceName:n.service.serviceName,beautician:n.selectedBeautician.nickName,date:n.selectedDate.date.toDateString()+" "+n.selectedTime.time.toString()};f.goParams("appointment_success",t)})}}]);